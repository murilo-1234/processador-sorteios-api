// src/app.js
const express = require('express');
const path = require('path');
const fs = require('fs');
const logger = require('./config/logger');
const database = require('./config/database');

// Configura√ß√£o espec√≠fica para Render
const app = express();
app.set('trust proxy', 1); // Configura√ß√£o para proxy do Render

// Middleware b√°sico
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// Servir arquivos est√°ticos
app.use(express.static(path.join(__dirname, '..', 'public')));

// ===== ROTAS B√ÅSICAS PRIMEIRO (RENDER OPTIMIZATION) =====

// Health check - PRIMEIRA ROTA para Render
app.get('/health', (req, res) => {
  const whatsappClient = req.app.locals.whatsappClient;
  const status = whatsappClient?.getConnectionStatus() || { isConnected: false };
  
  res.json({ 
    status: 'ok', 
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    whatsapp: {
      connected: status.isConnected,
      realConnected: status.realConnectionStatus,
      monitoring: status.heartbeatActive && status.monitoringActive
    },
    renderOptimized: true
  });
});

// Root - SEGUNDA ROTA
app.get('/', (req, res) => {
  res.json({ 
    message: 'WhatsApp Automation - Detec√ß√£o de Desconex√£o Implementada',
    status: 'running',
    version: '2.0.0-detection',
    timestamp: new Date().toISOString(),
    features: [
      'Detec√ß√£o ativa de desconex√£o manual',
      'Heartbeat para verifica√ß√£o cont√≠nua',
      'Reset inteligente autom√°tico',
      'Diagn√≥stico completo do sistema',
      'Monitoramento em tempo real'
    ]
  });
});

// QR Code endpoint - TERCEIRA ROTA (importante para funcionamento)
app.get('/qr', (req, res) => {
  try {
    const whatsappClient = req.app.locals.whatsappClient;
    
    if (!whatsappClient) {
      return res.status(503).json({
        error: 'Cliente WhatsApp n√£o inicializado',
        message: 'Sistema ainda inicializando. Aguarde alguns segundos.',
        suggestion: 'Tente /api/diagnostico-completo para verificar o status'
      });
    }
    
    const status = whatsappClient.getConnectionStatus();
    
    // Verificar se h√° inconsist√™ncia de conex√£o
    if (status.isConnected && !status.realConnectionStatus) {
      return res.json({
        error: 'Conex√£o inconsistente detectada',
        message: 'Sistema detectou que WhatsApp foi desconectado manualmente',
        suggestion: 'Use /api/detectar-desconexao para reset autom√°tico',
        status: {
          internal: status.isConnected,
          real: status.realConnectionStatus
        }
      });
    }
    
    if (whatsappClient.isConnected && status.realConnectionStatus) {
      return res.json({
        connected: true,
        message: 'WhatsApp j√° est√° conectado',
        user: status.user,
        monitoring: status.heartbeatActive && status.monitoringActive
      });
    }
    
    if (whatsappClient.currentQRCode) {
      // Gerar QR Code como SVG
      const qrcode = require('qrcode');
      qrcode.toString(whatsappClient.currentQRCode, { type: 'svg', width: 256 }, (err, svg) => {
        if (err) {
          logger.error('‚ùå Erro ao gerar SVG do QR:', err);
          return res.status(500).json({
            error: 'Erro ao gerar QR Code',
            message: err.message,
            suggestion: 'Tente /api/force-qr-generation'
          });
        }
        
        res.setHeader('Content-Type', 'image/svg+xml');
        res.send(svg);
      });
    } else if (whatsappClient.currentPairingCode) {
      res.json({
        pairingCode: whatsappClient.currentPairingCode,
        message: 'Use o c√≥digo de pareamento no WhatsApp'
      });
    } else {
      res.status(503).json({
        error: 'QR Code n√£o dispon√≠vel',
        message: 'WhatsApp pode j√° estar conectado ou aguardando conex√£o',
        qrGenerated: status.qrCodeGenerated,
        attempts: status.connectionAttempts,
        suggestions: [
          'Tente /api/detectar-desconexao para verificar desconex√£o manual',
          'Use /api/reset-inteligente para reset autom√°tico',
          'Use /api/force-qr-generation para for√ßar novo QR'
        ]
      });
    }
    
  } catch (error) {
    logger.error('‚ùå Erro no endpoint /qr:', error);
    res.status(500).json({
      error: 'Erro interno no QR Code',
      message: error.message,
      suggestion: 'Use /api/diagnostico-completo para an√°lise detalhada'
    });
  }
});

// Endpoint de diagn√≥stico r√°pido
app.get('/diagnostico', async (req, res) => {
  try {
    const whatsappClient = req.app.locals.whatsappClient;
    
    if (!whatsappClient) {
      return res.json({
        status: 'error',
        message: 'Cliente WhatsApp n√£o inicializado',
        action: 'restart_required'
      });
    }
    
    const status = whatsappClient.getConnectionStatus();
    const diagnostics = await whatsappClient.getDiagnostics();
    
    // Verificar problemas comuns
    const problems = [];
    const solutions = [];
    
    if (status.isConnected && !status.realConnectionStatus) {
      problems.push('Desconex√£o manual detectada');
      solutions.push('Use /api/detectar-desconexao');
    }
    
    if (!status.isConnected && !status.qrCodeGenerated) {
      problems.push('N√£o conectado e sem QR Code');
      solutions.push('Use /api/force-qr-generation');
    }
    
    if (status.missedHeartbeats >= 2) {
      problems.push(`Heartbeats perdidos: ${status.missedHeartbeats}`);
      solutions.push('Use /api/reset-inteligente');
    }
    
    if (diagnostics.sessionCorrupted) {
      problems.push('Sess√£o corrompida');
      solutions.push('Use /api/reset-nuclear');
    }
    
    res.json({
      status: problems.length === 0 ? 'ok' : 'warning',
      timestamp: new Date().toISOString(),
      connection: {
        internal: status.isConnected,
        real: status.realConnectionStatus,
        consistent: status.isConnected === status.realConnectionStatus
      },
      monitoring: {
        heartbeat: status.heartbeatActive,
        connectionCheck: status.monitoringActive,
        missedHeartbeats: status.missedHeartbeats
      },
      problems,
      solutions,
      quickActions: [
        '/api/detectar-desconexao - Verificar desconex√£o manual',
        '/api/reset-inteligente - Reset autom√°tico inteligente',
        '/api/diagnostico-completo - An√°lise detalhada'
      ]
    });
    
  } catch (error) {
    logger.error('‚ùå Erro no diagn√≥stico r√°pido:', error);
    res.status(500).json({
      status: 'error',
      message: 'Erro no diagn√≥stico: ' + error.message
    });
  }
});

// ===== INICIALIZA√á√ÉO ASS√çNCRONA (N√ÉO BLOQUEIA RENDER) =====

let initializationStarted = false;

async function initializeServices() {
  if (initializationStarted) return;
  initializationStarted = true;
  
  try {
    logger.info('üöÄ Inicializando servi√ßos em background (Detection Mode)...');
    
    // 1. Inicializar banco de dados
    logger.info('üìä Inicializando banco de dados...');
    await database.initialize();
    logger.info('‚úÖ Banco de dados inicializado');
    
    // 2. Inicializar WhatsApp Client (modo ass√≠ncrono)
    logger.info('üì± Inicializando cliente WhatsApp com detec√ß√£o ativa...');
    const WhatsAppClient = require('./services/whatsapp-client');
    const whatsappClient = new WhatsAppClient();
    
    // Armazenar refer√™ncia global
    app.locals.whatsappClient = whatsappClient;
    
    // Configurar listeners para eventos importantes
    whatsappClient.on('forced-disconnect', (reason) => {
      logger.warn(`‚ö†Ô∏è Desconex√£o for√ßada detectada: ${reason}`);
    });
    
    whatsappClient.on('logged-out', () => {
      logger.warn('‚ö†Ô∏è WhatsApp foi deslogado, sess√£o limpa');
    });
    
    whatsappClient.on('max-retries-reached', () => {
      logger.error('‚ùå M√°ximo de tentativas de reconex√£o atingido');
    });
    
    whatsappClient.on('circuit-breaker-open', () => {
      logger.error('üî¥ Circuit breaker aberto - muitas falhas');
    });
    
    // Inicializar de forma ass√≠ncrona (n√£o bloqueia)
    whatsappClient.initialize().catch(err => {
      logger.error('‚ùå Erro na inicializa√ß√£o do WhatsApp:', err);
    });
    
    // 3. Configurar job scheduler (se existir)
    try {
      const JobScheduler = require('./modules/job-scheduler');
      const jobScheduler = new JobScheduler(whatsappClient);
      app.locals.jobScheduler = jobScheduler;
      
      // Inicializar jobs de forma ass√≠ncrona
      setTimeout(() => {
        jobScheduler.start().catch(err => {
          logger.error('‚ùå Erro ao iniciar jobs:', err);
        });
      }, 10000); // Aguardar mais tempo para WhatsApp estar pronto
      
      logger.info('‚úÖ Job scheduler configurado');
    } catch (err) {
      logger.warn('‚ö†Ô∏è Job scheduler n√£o dispon√≠vel:', err.message);
    }
    
    logger.info('‚úÖ Inicializa√ß√£o de servi√ßos conclu√≠da (modo detec√ß√£o ativa)');
    
  } catch (error) {
    logger.error('‚ùå Erro na inicializa√ß√£o de servi√ßos:', error);
  }
}

// ===== CARREGAR ROTAS AP√ìS INICIALIZA√á√ÉO B√ÅSICA =====

// Rotas da API
app.use('/api', require('./routes/api'));

// Rotas administrativas
try {
  app.use('/admin', require('./routes/admin'));
  logger.info('‚úÖ Rotas administrativas carregadas');
} catch (err) {
  logger.warn('‚ö†Ô∏è Rotas administrativas n√£o dispon√≠veis:', err.message);
}

// ===== MIDDLEWARE DE ERRO =====

app.use((err, req, res, next) => {
  logger.error('‚ùå Erro n√£o tratado:', err);
  res.status(500).json({
    error: 'Erro interno do servidor',
    message: process.env.NODE_ENV === 'development' ? err.message : 'Erro interno',
    suggestion: 'Use /api/diagnostico-completo para an√°lise detalhada'
  });
});

// 404 handler
app.use((req, res) => {
  res.status(404).json({
    error: 'Endpoint n√£o encontrado',
    path: req.path,
    availableEndpoints: [
      '/health - Status do sistema',
      '/qr - QR Code do WhatsApp',
      '/diagnostico - Diagn√≥stico r√°pido',
      '/api/diagnostico-completo - An√°lise detalhada',
      '/api/detectar-desconexao - Verificar desconex√£o manual',
      '/api/reset-inteligente - Reset autom√°tico',
      '/api/force-qr-generation - For√ßar novo QR'
    ]
  });
});

// ===== INICIALIZA√á√ÉO DO SERVIDOR =====

const PORT = process.env.PORT || 3000;

const server = app.listen(PORT, '0.0.0.0', () => {
  logger.info(`üöÄ Servidor rodando na porta ${PORT} (Detection Mode)`);
  logger.info(`üì± QR Code dispon√≠vel em: http://localhost:${PORT}/qr`);
  logger.info(`üîß Health check: http://localhost:${PORT}/health`);
  logger.info(`üîç Diagn√≥stico: http://localhost:${PORT}/diagnostico`);
  logger.info(`üß† Reset inteligente: http://localhost:${PORT}/api/reset-inteligente`);
  
  // Inicializar servi√ßos AP√ìS servidor estar rodando
  setTimeout(() => {
    initializeServices().catch(err => {
      logger.error('‚ùå Erro na inicializa√ß√£o tardia:', err);
    });
  }, 1000);
});

// ===== GRACEFUL SHUTDOWN =====

process.on('SIGTERM', async () => {
  logger.info('üîÑ SIGTERM recebido, iniciando shutdown graceful...');
  
  server.close(async () => {
    try {
      // Parar monitoramento do WhatsApp
      if (app.locals.whatsappClient) {
        app.locals.whatsappClient.stopMonitoring();
        await app.locals.whatsappClient.disconnect();
        logger.info('‚úÖ WhatsApp desconectado e monitoramento parado');
      }
      
      // Parar jobs
      if (app.locals.jobScheduler) {
        await app.locals.jobScheduler.stop();
        logger.info('‚úÖ Jobs parados');
      }
      
      // Fechar banco
      if (database.close) {
        await database.close();
        logger.info('‚úÖ Banco de dados fechado');
      }
      
      logger.info('‚úÖ Shutdown graceful conclu√≠do');
      process.exit(0);
    } catch (error) {
      logger.error('‚ùå Erro no shutdown:', error);
      process.exit(1);
    }
  });
});

process.on('SIGINT', async () => {
  logger.info('üîÑ SIGINT recebido, iniciando shutdown...');
  process.emit('SIGTERM');
});

// ===== TRATAMENTO DE ERROS N√ÉO CAPTURADOS =====

process.on('uncaughtException', (error) => {
  logger.error('‚ùå Exce√ß√£o n√£o capturada:', error);
  // N√£o fazer exit para manter servidor rodando no Render
});

process.on('unhandledRejection', (reason, promise) => {
  logger.error('‚ùå Promise rejeitada n√£o tratada:', reason);
  // N√£o fazer exit para manter servidor rodando no Render
});

module.exports = app;

