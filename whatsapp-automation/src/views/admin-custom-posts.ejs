<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendamentos de Posts</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    h1 { color: #333; margin-bottom: 20px; }
    
    /* ABAS */
    .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e5e7eb; }
    .tab { padding: 12px 24px; cursor: pointer; background: transparent; border: none;
           font-size: 14px; font-weight: 600; color: #6b7280; border-bottom: 3px solid transparent;
           transition: all 0.2s; }
    .tab:hover { color: #3b82f6; background: #f3f4f6; }
    .tab.active { color: #3b82f6; border-bottom-color: #3b82f6; }
    .tab-badge { display: inline-block; background: #e5e7eb; color: #374151; 
                 padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 6px; }
    .tab.active .tab-badge { background: #dbeafe; color: #1e40af; }
    
    /* CONTE√öDO DAS ABAS */
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .form-section { background: white; padding: 20px; border-radius: 8px; 
                    margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
    input[type="file"], input[type="date"], input[type="time"] { 
      width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; 
    }
    textarea { width: 100%; min-height: 80px; padding: 8px; border: 1px solid #ddd; 
               border-radius: 4px; font-family: Arial; resize: vertical; }
    .textarea-counter { float: right; color: #666; font-size: 12px; margin-top: 2px; }
    button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 4px; 
             font-size: 14px; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-secondary { background: #6b7280; color: white; }
    .btn-secondary:hover { background: #4b5563; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    
    .post-card { background: white; border: 1px solid #ddd; padding: 15px; 
                 margin: 10px 0; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .status-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; 
                    font-size: 12px; font-weight: bold; }
    .status-agendado { background: #fef3c7; color: #92400e; }
    .status-postando { background: #dbeafe; color: #1e40af; }
    .status-conclu√≠do { background: #d1fae5; color: #065f46; }
    .status-cancelado { background: #fee2e2; color: #991b1b; }
    .status-expirado { background: #fecaca; color: #7f1d1d; }
    .status-duplicado { background: #fef3c7; color: #92400e; border: 2px dashed #f59e0b; }
    .post-actions { margin-top: 10px; }
    .post-actions button { margin-right: 5px; }
    
    .empty-state { text-align: center; padding: 40px; color: #6b7280; }
    .duplicado-badge { display: inline-block; background: #fef3c7; color: #92400e; 
                       padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 5px; }
  </style>
</head>
<body>
  <h1>üìÖ Agendamentos de Posts</h1>
  
  <!-- SISTEMA DE 4 ABAS -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('agendados')">
      Posts Agendados
      <span class="tab-badge" id="badge-agendados">0</span>
    </button>
    <button class="tab" onclick="switchTab('realizados')">
      Realizados
      <span class="tab-badge" id="badge-realizados">0</span>
    </button>
    <button class="tab" onclick="switchTab('cancelados')">
      Cancelados
      <span class="tab-badge" id="badge-cancelados">0</span>
    </button>
    <button class="tab" onclick="switchTab('duplicados')">
      Duplicados
      <span class="tab-badge" id="badge-duplicados">0</span>
    </button>
  </div>
  
  <!-- ABA 1: POSTS AGENDADOS -->
  <div id="tab-agendados" class="tab-content active">
    <div class="form-section">
      <h2>‚ûï Agendar Novo Post</h2>
      <form action="/admin/agendamentos/criar" method="POST" enctype="multipart/form-data">
        
        <div class="form-group">
          <label>üì∑ Imagem ou V√≠deo:</label>
          <input type="file" name="media" accept="image/*,video/*" required>
          <small style="color: #666;">M√°ximo 16MB | JPG, PNG, MP4</small>
        </div>
        
        <div class="form-group">
          <label>‚úçÔ∏è TEXTO 1 (obrigat√≥rio):</label>
          <textarea name="texto_1" maxlength="650" required 
                    oninput="updateCounter(this, 'counter1')"></textarea>
          <span id="counter1" class="textarea-counter">0/650</span>
        </div>
        
        <div class="form-group">
          <label>‚úçÔ∏è TEXTO 2 (obrigat√≥rio):</label>
          <textarea name="texto_2" maxlength="650" required 
                    oninput="updateCounter(this, 'counter2')"></textarea>
          <span id="counter2" class="textarea-counter">0/650</span>
        </div>
        
        <div class="form-group">
          <label>‚úçÔ∏è TEXTO 3 (obrigat√≥rio):</label>
          <textarea name="texto_3" maxlength="650" required 
                    oninput="updateCounter(this, 'counter3')"></textarea>
          <span id="counter3" class="textarea-counter">0/650</span>
        </div>
        
        <div class="form-group">
          <label>‚úçÔ∏è TEXTO 4 (obrigat√≥rio):</label>
          <textarea name="texto_4" maxlength="650" required 
                    oninput="updateCounter(this, 'counter4')"></textarea>
          <span id="counter4" class="textarea-counter">0/650</span>
        </div>
        
        <div class="form-group">
          <label>‚úçÔ∏è TEXTO 5 (obrigat√≥rio):</label>
          <textarea name="texto_5" maxlength="650" required 
                    oninput="updateCounter(this, 'counter5')"></textarea>
          <span id="counter5" class="textarea-counter">0/650</span>
        </div>
        
        <div class="form-group">
          <label>üìÖ Data:</label>
          <input type="date" name="data" required min="<%= today %>">
        </div>
        
        <div class="form-group">
          <label>‚è∞ Hora:</label>
          <input type="time" name="hora" required>
        </div>
        
        <button type="submit" class="btn-primary">üíæ Agendar Post</button>
      </form>
    </div>
    
    <h2>üìã Posts Agendados (<span id="count-agendados">0</span>)</h2>
    <div id="list-agendados"></div>
  </div>
  
  <!-- ABA 2: REALIZADOS -->
  <div id="tab-realizados" class="tab-content">
    <h2>‚úÖ Posts Realizados (<span id="count-realizados">0</span>)</h2>
    <div id="list-realizados"></div>
  </div>
  
  <!-- ABA 3: CANCELADOS -->
  <div id="tab-cancelados" class="tab-content">
    <h2>‚ùå Posts Cancelados (<span id="count-cancelados">0</span>)</h2>
    <div id="list-cancelados"></div>
  </div>
  
  <!-- ABA 4: DUPLICADOS -->
  <div id="tab-duplicados" class="tab-content">
    <h2>üìã Posts Duplicados (<span id="count-duplicados">0</span>)</h2>
    <p style="color: #6b7280; margin-bottom: 20px;">Posts criados via "Duplicar" aguardando edi√ß√£o e agendamento.</p>
    <div id="list-duplicados"></div>
  </div>
  
  <script>
    // Dados dos posts
    const allPosts = <%- JSON.stringify(posts) %>;
    
    // Filtrar posts por STATUS
    const postsAgendados = allPosts.filter(p => ['Agendado', 'Postando'].includes(p.STATUS));
    const postsRealizados = allPosts.filter(p => p.STATUS === 'Conclu√≠do');
    const postsCancelados = allPosts.filter(p => ['Cancelado', 'Expirado'].includes(p.STATUS));
    const postsDuplicados = allPosts.filter(p => p.STATUS === 'Duplicado');
    
    // Atualizar badges
    document.getElementById('badge-agendados').textContent = postsAgendados.length;
    document.getElementById('badge-realizados').textContent = postsRealizados.length;
    document.getElementById('badge-cancelados').textContent = postsCancelados.length;
    document.getElementById('badge-duplicados').textContent = postsDuplicados.length;
    
    document.getElementById('count-agendados').textContent = postsAgendados.length;
    document.getElementById('count-realizados').textContent = postsRealizados.length;
    document.getElementById('count-cancelados').textContent = postsCancelados.length;
    document.getElementById('count-duplicados').textContent = postsDuplicados.length;
    
    // Renderizar posts
    function renderPosts(posts, containerId) {
      const container = document.getElementById(containerId);
      
      if (posts.length === 0) {
        container.innerHTML = '<div class="empty-state">Nenhum post nesta categoria.</div>';
        return;
      }
      
      container.innerHTML = posts.map(post => {
        const statusClass = post.STATUS.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        const duplicadoInfo = post.DUPLICADO_DE ? 
          `<span class="duplicado-badge">üìã Copiado de: ${post.DUPLICADO_DE}</span>` : '';
        
        let buttons = '';
        
        if (post.STATUS === 'Agendado') {
          buttons = `
            <button onclick="editar('${post.ID}')" class="btn-secondary">‚úèÔ∏è Editar</button>
            <button onclick="duplicar('${post.ID}')" class="btn-secondary">üìã Duplicar</button>
            <button onclick="cancelar('${post.ID}')" class="btn-danger">‚ùå Cancelar</button>
          `;
        } else if (post.STATUS === 'Postando') {
          buttons = `
            <button onclick="cancelarRestante('${post.ID}')" class="btn-danger">‚ùå Cancelar Resto</button>
          `;
        } else if (post.STATUS === 'Duplicado') {
          buttons = `
            <button onclick="editar('${post.ID}')" class="btn-primary">‚úèÔ∏è Editar e Agendar</button>
            <button onclick="deletar('${post.ID}')" class="btn-danger">üóëÔ∏è Deletar</button>
          `;
        } else if (['Conclu√≠do', 'Cancelado', 'Expirado'].includes(post.STATUS)) {
          buttons = `
            <button onclick="duplicar('${post.ID}')" class="btn-secondary">üìã Duplicar</button>
            <button onclick="deletar('${post.ID}')" class="btn-danger">üóëÔ∏è Deletar</button>
          `;
        }
        
        return `
          <div class="post-card">
            <span class="status-badge status-${statusClass}">${post.STATUS}</span>
            <strong>${post.ID}</strong> - ${post.DATA} ${post.HORA}
            ${duplicadoInfo}
            <br>
            <small>Texto 1: ${post.TEXTO_1.substring(0, 50)}...</small>
            <br>
            üë• ${post.gruposPostados}/${post.totalGrupos} grupos
            <div class="post-actions">${buttons}</div>
          </div>
        `;
      }).join('');
    }
    
    renderPosts(postsAgendados, 'list-agendados');
    renderPosts(postsRealizados, 'list-realizados');
    renderPosts(postsCancelados, 'list-cancelados');
    renderPosts(postsDuplicados, 'list-duplicados');
    
    // Trocar abas
    function switchTab(tabName) {
      // Desativar todas as abas
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      // Ativar aba clicada
      document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');
    }
    
    function updateCounter(textarea, counterId) {
      document.getElementById(counterId).textContent = textarea.value.length + '/650';
    }
    
    function editar(id) {
      window.location.href = '/admin/agendamentos/editar/' + id;
    }
    
    function duplicar(id) {
      if (confirm('Duplicar este post? Ser√° criada uma c√≥pia na aba "Duplicados" aguardando edi√ß√£o.')) {
        fetch('/admin/agendamentos/duplicar/' + id, { method: 'POST' })
          .then(() => location.reload());
      }
    }
    
    function cancelar(id) {
      if (confirm('Cancelar este agendamento?')) {
        fetch('/admin/agendamentos/cancelar/' + id, { method: 'POST' })
          .then(() => location.reload());
      }
    }
    
    function cancelarRestante(id) {
      if (confirm('Cancelar postagens restantes?')) {
        fetch('/admin/agendamentos/cancelar/' + id, { method: 'POST' })
          .then(() => location.reload());
      }
    }
    
    function deletar(id) {
      if (confirm('Deletar permanentemente?')) {
        fetch('/admin/agendamentos/deletar/' + id, { method: 'DELETE' })
          .then(() => location.reload());
      }
    }
  </script>
</body>
</html>
