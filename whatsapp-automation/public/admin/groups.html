<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grupos WhatsApp ‚Ä¢ Sele√ß√£o</title>
  <style>
    :root{ --b:#1f2937; --primary:#2563eb; }

    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0f172a; color:#e2e8f0; margin:0; }
    .wrap { max-width: 1000px; margin: 28px auto; padding: 0 16px; }

    /* ====== ABAS ====== */
    .tabs{display:flex; gap:8px; margin:0 0 18px 0; flex-wrap:wrap}
    .tab{
      display:inline-block; padding:.55rem .9rem; border-radius:10px;
      border:1px solid var(--b); background:#101827; color:#dbe2f0; text-decoration:none
    }
    .tab.active{ background:var(--primary); border-color:transparent; color:#fff }
    .tab:hover{ filter:brightness(1.05) }

    .card { background:#111827; border:1px solid var(--b); border-radius:14px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    h1 { margin:0 0 8px; font-weight:700; color:#f8fafc; }
    .muted { color:#94a3b8; font-size:14px; margin-bottom:18px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; align-items:center; }
    button { background:#2563eb; color:#fff; border:0; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:600; }
    button.secondary { background:#334155; }
    button:disabled { opacity:.5; cursor:not-allowed; }

    /* Filtros */
    .filters { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:12px 0 4px; }
    .input {
      background:#0b1220; color:#e2e8f0; border:1px solid #1f2937; border-radius:10px; padding:10px 12px;
      outline:none; min-width:220px;
    }
    .check { display:flex; align-items:center; gap:6px; font-size:14px; color:#cbd5e1; }
    .counter { margin-left:auto; color:#9fb3c8; font-size:13px; }

    table { width:100%; border-collapse: collapse; margin-top:12px; }
    th, td { padding:10px; border-bottom:1px solid var(--b); vertical-align: middle; }
    th { text-align:left; color:#cbd5e1; }
    tr:hover { background:#0b1220; }
    .right { text-align:right; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#0ea5e9; color:#08121d; font-weight:700; }
    .tag { display:inline-block; padding:2px 6px; border-radius:6px; background:#0b3b6d; font-size:12px; color:#93c5fd; margin-left:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- ABAS / ATALHOS -->
    <nav class="tabs">
      <a class="tab" data-path="/admin/whatsapp" href="/admin/whatsapp">WhatsApp</a>
      <a class="tab" data-path="/admin/groups" href="/admin/groups">Grupos</a>
      <a class="tab" data-path="/admin/wa/logs" href="/admin/wa/logs" target="_blank" rel="noopener">Logs</a>
      <a class="tab" data-path="/api/whatsapp/status" href="/api/whatsapp/status" target="_blank" rel="noopener">Status JSON</a>
    </nav>

    <div class="card">
      <h1>Grupos do WhatsApp</h1>
      <div class="muted">Sincronize os grupos e escolha <b>um ou mais</b> para postar os resultados dos sorteios.</div>

      <div class="row">
        <button id="btnSync">üîÑ Sincronizar grupos</button>
        <button id="btnSave" class="secondary">üíæ Salvar sele√ß√£o</button>
        <button id="btnTest" class="secondary">üß™ Testar postagem</button>
        <span id="status" class="muted"></span>
      </div>

      <!-- Filtros -->
      <div class="filters">
        <input id="q" class="input" type="search" placeholder="Buscar por nome ou JID..." />
        <label class="check"><input id="fAdmins" type="checkbox"> Somente ‚Äúsomente admin‚Äù</label>
        <label class="check"><input id="fSelected" type="checkbox"> Somente selecionados</label>
        <span id="count" class="counter"></span>
      </div>

      <div id="meta" class="muted">Carregando‚Ä¶</div>

      <table>
        <thead>
          <tr>
            <th>Selecionar</th>
            <th>Nome do grupo</th>
            <th class="right">Participantes</th>
            <th>JID</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // marca a aba ativa
    (function(){
      const p = location.pathname;
      document.querySelectorAll('.tab').forEach(a=>{
        if (p === a.getAttribute('data-path')) a.classList.add('active');
      });
    })();

    const $ = (s) => document.querySelector(s);
    const tbody   = $('#tbody');
    const meta    = $('#meta');
    const status  = $('#status');
    const btnSync = $('#btnSync');
    const btnSave = $('#btnSave');
    const btnTest = $('#btnTest');

    const q        = $('#q');
    const fAdmins  = $('#fAdmins');
    const fSelected= $('#fSelected');
    const countEl  = $('#count');

    let groups = [];
    let selected = new Set(); // v√°rios grupos
    let visible = [];         // cache da lista filtrada

    async function getJSON(url, opts) {
      const r = await fetch(url, Object.assign({ headers: { 'Content-Type': 'application/json' } }, opts));
      const j = await r.json();
      if (!r.ok) throw new Error(j.error || JSON.stringify(j));
      return j;
    }

    function applyFilters() {
      const term = q.value.trim().toLowerCase();
      visible = groups.filter(g => {
        if (fAdmins.checked && !g.announce) return false; // ‚Äúsomente admin‚Äù (announce=true)
        if (fSelected.checked && !selected.has(g.jid)) return false;
        if (term) {
          const hay = (g.name || '') + ' ' + (g.jid || '');
          if (!hay.toLowerCase().includes(term)) return false;
        }
        return true;
      });
      countEl.textContent = `${visible.length} de ${groups.length} grupo(s)`;
    }

    function render() {
      applyFilters();
      tbody.innerHTML = visible.map(g => {
        const checked = selected.has(g.jid) ? 'checked' : '';
        const annTag  = g.announce ? '<span class="tag">somente admin</span>' : '';
        return `
          <tr>
            <td><input class="group-select" type="checkbox" data-jid="${g.jid}" ${checked}></td>
            <td>${g.name} ${annTag}</td>
            <td class="right"><span class="pill">${g.participants ?? 0}</span></td>
            <td><small>${g.jid}</small></td>
          </tr>`;
      }).join('');

      tbody.querySelectorAll('.group-select').forEach(el => {
        el.addEventListener('change', (ev) => {
          const jid = ev.target.dataset.jid;
          if (ev.target.checked) selected.add(jid);
          else selected.delete(jid);
        });
      });
    }

    async function loadSaved() {
      const data = await getJSON('/api/groups');
      const st = data.settings || {};

      groups = st.groups || [];

      // legado ‚Üí se s√≥ tiver resultGroupJid, seleciona ele
      const list = Array.isArray(st.postGroupJids) && st.postGroupJids.length
        ? st.postGroupJids
        : (st.resultGroupJid ? [st.resultGroupJid] : []);

      selected = new Set(list);
      render();

      meta.textContent = st.lastSyncAt
        ? `√öltima sincroniza√ß√£o: ${new Date(st.lastSyncAt).toLocaleString()}`
        : 'Ainda n√£o sincronizado';
    }

    btnSync.onclick = async () => {
      try {
        status.textContent = 'Sincronizando...';
        const data = await getJSON('/api/groups/sync');
        groups = data.groups || [];
        render();
        meta.textContent = data.saved?.lastSyncAt
          ? `√öltima sincroniza√ß√£o: ${new Date(data.saved.lastSyncAt).toLocaleString()}`
          : '';
        status.textContent = 'Feito ‚úÖ';
        setTimeout(() => (status.textContent = ''), 2500);
      } catch (e) {
        status.textContent = 'Erro ao sincronizar ‚ùå';
        alert(e.message);
      }
    };

    btnSave.onclick = async () => {
      try {
        if (!selected.size) return alert('Selecione pelo menos um grupo.');
        status.textContent = 'Salvando...';
        await getJSON('/api/groups/select', {
          method: 'POST',
          body: JSON.stringify({ postGroupJids: Array.from(selected) })
        });
        status.textContent = 'Salvo ‚úÖ';
        setTimeout(() => (status.textContent = ''), 2500);
      } catch (e) {
        status.textContent = 'Erro ao salvar ‚ùå';
        alert(e.message);
      }
    };

    btnTest.onclick = async () => {
      try {
        status.textContent = 'Enviando teste...';
        const r = await getJSON('/api/groups/test-post', { method: 'POST' });
        status.textContent = `Mensagem enviada ‚úÖ (${r.sentTo} grupo(s))`;
        setTimeout(() => (status.textContent = ''), 2500);
      } catch (e) {
        status.textContent = 'Falha no teste ‚ùå';
        alert(e.message);
      }
    };

    // listeners de filtro
    q.addEventListener('input', render);
    fAdmins.addEventListener('change', render);
    fSelected.addEventListener('change', render);

    loadSaved().catch(console.error);
  </script>
</body>
</html>
